<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
    <title>1êµì‹œ ê¹€í˜„ì„ êµ­ì–´</title>
    <link rel="apple-touch-icon" href="https://saenarachild-crypto.github.io/kim-korean-homework/logo.jpeg">
    <link rel="icon" href="https://saenarachild-crypto.github.io/kim-korean-homework/logo.jpeg">
    <script src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.0/kakao.min.js"></script>
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        :root { --p: #6c5ce7; --bg: #f8f9fc; --border: #e2e8f0; --accent: #ff7675; }
        body { background: var(--bg); font-family: 'Pretendard', sans-serif; margin: 0; padding: 15px; color: #2d3436; -webkit-tap-highlight-color: transparent; }
        .container { max-width: 500px; margin: 0 auto; background: #fff; padding: 25px; border-radius: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.03); box-sizing: border-box; }
        #introPage, #examPage { display: none; }
        .show { display: block !important; }
        .header-logo { text-align: center; margin-bottom: 20px; width: 100%; }
        .header-logo img { width: 100%; max-width: 300px; height: auto; object-fit: contain; border-radius: 15px; display: block; margin: 0 auto; }
        .q-card { border: 1px solid var(--border); border-radius: 20px; padding: 20px; margin-bottom: 15px; background: #fff; }
        .ans-row { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; position: relative; }
        input[type="radio"] { position: absolute; opacity: 0; pointer-events: none; }
        .ans-row label { height: 45px; display: flex; align-items: center; justify-content: center; border: 1px solid var(--border); border-radius: 12px; cursor: pointer; font-weight: 700; background: #fff; z-index: 2; }
        input[type="radio"]:checked + label { background: var(--p); color: white; border-color: var(--p); }
        .main-btn { width: 100%; padding: 20px; background: var(--p); color: white; border: none; border-radius: 20px; font-size: 1.1em; font-weight: 800; cursor: pointer; box-sizing: border-box; }
        #resultModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; overflow-y: auto; padding: 15px; box-sizing: border-box; }
        .modal-content { background: #fff; border-radius: 30px; padding: 25px; max-width: 500px; margin: 20px auto; box-sizing: border-box; }
        #chart_div { width: 100%; height: 200px; margin: 15px 0; }
        .wrong-box { background:#fff0f0; padding:15px; border-radius:12px; color:#c0392b; font-weight:700; margin:15px 0; line-height:1.6; font-size:0.9em; word-break: break-all; }
        .finished-msg { background: #f1f2f6; color: #57606f; padding: 15px; border-radius: 15px; text-align: center; font-weight: 700; margin-bottom: 20px; display: none; border: 2px solid #ccc; }
    </style>
</head>
<body>
<div class="container">
    <div id="introPage" class="show">
        <div class="header-logo"><img src="https://saenarachild-crypto.github.io/kim-korean-homework/logo.jpeg"></div>
        <div class="input-grid" style="display:flex; gap:10px; margin-bottom:20px;">
            <input type="text" id="academyName" placeholder="í•™ì›ëª…" style="flex:1; padding:15px; border-radius:15px; border:1px solid #ddd; text-align:center;">
            <input type="text" id="stuName" placeholder="í•™ìƒ ì´ë¦„" style="flex:1; padding:15px; border-radius:15px; border:1px solid #ddd; text-align:center;">
        </div>
        <button id="startBtn" class="main-btn" onclick="checkServerBeforeStart()">ë³¸ì¸ í™•ì¸ ì™„ë£Œ (ê³¼ì œ ì‹œì‘)</button>
    </div>
    <div id="examPage">
        <div class="header-logo"><img src="https://saenarachild-crypto.github.io/kim-korean-homework/logo.jpeg"></div>
        <div id="finishMsg" class="finished-msg">âœ… ìµœì¢… ì œì¶œì´ ì™„ë£Œëœ ì‹œí—˜ì…ë‹ˆë‹¤.</div>
        <div id="questionsContainer"></div>
        <button id="submitBtn" class="main-btn" onclick="processSubmit()">ì œì¶œ ë° ì„œë²„ ì±„ì </button>
        <button id="kakaoBtn" class="main-btn" onclick="shareAndUnlock()" style="display:none; background:#fee500; color:#3c1e1e;">ğŸŸ¡ ì¹´í†¡ ì „ì†¡ í›„ ê²°ê³¼ í™•ì¸</button>
        <button id="reviewBtn" class="main-btn" style="display:none; background:#2f3542;" onclick="showLastResult()">ğŸ“Š ìµœì¢… ë¦¬í¬íŠ¸ ë‹¤ì‹œ ë³´ê¸°</button>
    </div>
</div>
<div id="resultModal"><div class="modal-content"><h2 style="text-align:center;">ğŸ“Š ë¦¬í¬íŠ¸</h2><div id="resSummary" style="font-weight:800; margin:20px 0; font-size:1.3em; text-align:center;"></div><div id="historyArea" style="display:none;"><div id="chart_div"></div><p style="font-size:0.8em; color:#666; text-align:center;">* ìœ„ë¡œ ê°ˆìˆ˜ë¡ ì„±ì ì´ ì¢‹ì•„ì§€ëŠ” ê·¸ë˜í”„ì…ë‹ˆë‹¤.</p></div><div id="solArea"></div><button class="main-btn" style="background:#f1f2f6; color:#333; margin-top:20px;" onclick="closeModal()">ê²°ê³¼ì°½ ë‹«ê¸°</button></div></div>

<script>
    google.charts.load('current', {'packages':['corechart']});
    const KAKAO_KEY = "f81d5eae0eaaf6fa2d0bdccbe6916001", GAS_URL = "https://script.google.com/macros/s/AKfycbxcT0dziBtsHKDZEPwzyBySOkZjfl3_B7nSysFX7DlXyDKiAD03zLI3jXI8ZBNbA31C/exec";
    const TASKS = { "1ì›” 3íšŒì°¨ ë¬¸í•™": { id: "2601_03_LIT", sol: "https://goe2427-my.sharepoint.com/:b:/g/personal/pure173_jeonghyeonh_goe_go_kr/IQC55ZuoL-2GSrdGKtWFXkzyARIkd0dBWnPkWxekrIjZznY?e=bR0L3e", nums: Array.from({length: 31}, (_, i) => i + 1) } };
    let serverRes = null;
    try { if (KAKAO_KEY) Kakao.init(KAKAO_KEY); } catch(e) {}

    function getUserKey() { return "v74.2_" + document.getElementById('stuName').value.trim(); }

    window.onload = async () => {
        const params = new URLSearchParams(window.location.search);
        if(params.get('viewResult') === 'true') {
            document.getElementById('stuName').value = params.get('name');
            document.getElementById('academyName').value = params.get('academy');
            await checkServerBeforeStart(true);
        }
    };

    async function checkServerBeforeStart(direct = false) {
        const name = document.getElementById('stuName').value.trim();
        if(!name) return alert("ì´ë¦„ ì…ë ¥!");
        document.getElementById('startBtn').innerText = "ë°ì´í„° ëŒ€ì¡° ì¤‘...";
        try {
            const res = await fetch(GAS_URL + "?check=true&name=" + encodeURIComponent(name));
            const data = await res.json();
            if(data.finished) {
                localStorage.setItem('finished_' + getUserKey(), 'true');
                localStorage.setItem('last_res_' + getUserKey(), JSON.stringify(data.lastRes));
                if(direct) { startExam(); return showLastResult(); }
            }
            startExam();
        } catch(e) { startExam(); }
    }

    function startExam() { document.getElementById('introPage').classList.remove('show'); document.getElementById('examPage').classList.add('show'); loadExam(); }

    function loadExam() {
        const userKey = getUserKey();
        if(localStorage.getItem('finished_' + userKey) === 'true') { lockExamPermanently(); return; }
        let html = "";
        TASKS["1ì›” 3íšŒì°¨ ë¬¸í•™"].nums.forEach(n => {
            html += `<div class="q-card"><b>${n}ë²ˆ</b><div class="ans-row">${[1,2,3,4,5].map(v => `<input type="radio" name="q${n}" value="${v}" id="q${n}_${v}"><label for="q${n}_${v}">${v}</label>`).join('')}</div></div>`;
        });
        document.getElementById('questionsContainer').innerHTML = html;
    }

    async function processSubmit() {
        const btn = document.getElementById('submitBtn'); btn.disabled = true; btn.innerText = "ì±„ì  ì¤‘...";
        const name = document.getElementById('stuName').value, academy = document.getElementById('academyName').value;
        const answers = TASKS["1ì›” 3íšŒì°¨ ë¬¸í•™"].nums.map(n => document.querySelector(`input[name="q${n}"]:checked`)?.value || 0);
        try {
            const res = await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ examId: TASKS["1ì›” 3íšŒì°¨ ë¬¸í•™"].id, name, academy, answers }) });
            serverRes = await res.json();
            btn.style.display = 'none'; document.getElementById('kakaoBtn').style.display = 'block';
        } catch(e) { alert("ì œì¶œì‹¤íŒ¨"); btn.disabled = false; }
    }

    function shareAndUnlock() {
        const currentTry = serverRes.try || 1, name = document.getElementById('stuName').value, academy = document.getElementById('academyName').value;
        const bustUrl = 'https://saenarachild-crypto.github.io/kim-korean-homework/logo.jpeg?v=' + Date.now();
        const callUrl = window.location.origin + window.location.pathname + "?viewResult=true&name=" + encodeURIComponent(name) + "&academy=" + encodeURIComponent(academy);
        
        const kakaoObj = {
            objectType: 'feed',
            content: {
                title: `[${academy}] ì œì¶œ ì™„ë£Œ`,
                description: `${name} í•™ìƒ (${currentTry}íšŒì°¨)`,
                imageUrl: bustUrl, imageWidth: 400, imageHeight: 400,
                link: { mobileWebUrl: window.location.href, webUrl: window.location.href }
            }
        };

        if(currentTry >= 3) {
            kakaoObj.buttons = [{ title: 'ê²°ê³¼ í™•ì¸í•˜ê¸°', link: { mobileWebUrl: callUrl, webUrl: callUrl } }];
        }

        Kakao.Share.sendDefault(kakaoObj);
        setTimeout(() => {
            if(confirm("ì„ ìƒë‹˜ê»˜ ì „ì†¡ì„ ì™„ë£Œí•˜ì…¨ë‚˜ìš”?")) {
                displayResult(); document.getElementById('resultModal').style.display = 'block';
                if(currentTry >= 3) { localStorage.setItem('finished_' + getUserKey(), 'true'); localStorage.setItem('last_res_' + getUserKey(), JSON.stringify(serverRes)); }
            }
        }, 1500); 
    }

    function displayResult() {
        const currentTry = serverRes.try || 1, count = serverRes.wrongCount || 0;
        document.getElementById('resSummary').innerHTML = `ì˜¤ë‹µ ê°œìˆ˜: <span style="color:var(--accent)">${count}ê°œ</span><br>(${currentTry}íšŒì°¨ ì œì¶œ ì™„ë£Œ)`;
        if(currentTry >= 3) {
            document.getElementById('historyArea').style.display = 'block';
            document.getElementById('solArea').innerHTML = `<div class="wrong-box">âŒ í‹€ë¦° ë¬¸í•­:<br>${serverRes.wrongs}</div><a href="${TASKS['1ì›” 3íšŒì°¨ ë¬¸í•™'].sol}" class="main-btn" target="_blank" style="display:block; text-decoration:none; text-align:center; margin-bottom:10px;">ìµœì¢… í•´ì„¤ì§€ í™•ì¸í•˜ê¸°</a>`;
            setTimeout(drawChart, 300);
        } else {
            document.getElementById('solArea').innerHTML = `<p style="color:blue; text-align:center; padding:10px;">${currentTry === 1 ? '2íšŒì°¨ì— í‹€ë¦° ë¬¸í•­ì´ ê³µê°œë©ë‹ˆë‹¤.' : 'âŒ í‹€ë¦° ë¬¸í•­: ' + serverRes.wrongs}</p>`;
        }
    }

    function drawChart() {
        const chartData = [['íšŒì°¨', 'ì˜¤ë‹µ']];
        serverRes.history.forEach((h, idx) => chartData.push([(idx+1)+"íšŒ", Number(h.wrongCount)]));
        const maxVal = Math.max(...serverRes.history.map(h => Number(h.wrongCount))) + 1;
        new google.visualization.LineChart(document.getElementById('chart_div')).draw(google.visualization.arrayToDataTable(chartData), {
            legend: 'none', colors: ['#ff7675'],
            vAxis: { direction: -1, minValue: 0, viewWindow: { min: 0, max: maxVal }, gridlines: { count: maxVal + 1 }, format: '0' },
            chartArea: { width: '85%', height: '70%' }, pointSize: 7
        });
    }

    function lockExamPermanently() { document.getElementById('questionsContainer').innerHTML = "<div style='text-align:center; padding:50px; color:#999; font-weight:700;'>ì œì¶œ ì™„ë£Œë¡œ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>"; document.getElementById('submitBtn').style.display = 'none'; document.getElementById('kakaoBtn').style.display = 'none'; document.getElementById('reviewBtn').style.display = 'block'; document.getElementById('finishMsg').style.display = 'block'; }
    function showLastResult() { const saved = JSON.parse(localStorage.getItem('last_res_' + getUserKey())); if (saved) { serverRes = saved; displayResult(); document.getElementById('resultModal').style.display = 'block'; } }
    function closeModal() { document.getElementById('resultModal').style.display = 'none'; }
</script>
</body>
</html>
