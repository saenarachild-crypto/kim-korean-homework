<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
    <title>1êµì‹œ ê¹€í˜„ì„ êµ­ì–´</title>
    <script src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.0/kakao.min.js"></script>
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        :root { --p: #6c5ce7; --bg: #f8f9fc; --border: #e2e8f0; }
        body { background: var(--bg); font-family: 'Pretendard', sans-serif; margin: 0; padding: 20px; color: #2d3436; -webkit-tap-highlight-color: transparent; }
        .container { max-width: 650px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.03); }
        
        /* ë¡œê³  ë””ìì¸ */
        .header-logo { text-align: center; margin-bottom: 25px; }
        .header-logo img { width: 130px; height: auto; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        /* ê³¼ì œ ì„ íƒ */
        .selector-box { background: #eeebff; padding: 18px; border-radius: 20px; border: 1.5px solid #d1ccff; margin-bottom: 25px; }
        select { width: 100%; padding: 15px; border-radius: 12px; border: 1px solid #c3b9ff; font-size: 1.1em; font-weight: 700; background: #fff; color: var(--p); outline: none; cursor: pointer; }
        
        /* ê³µì§€ì‚¬í•­ */
        .notice-box { background: #fff9f0; border-radius: 15px; padding: 20px; margin-bottom: 25px; line-height: 1.7; font-size: 0.95em; border: 1px solid #ffecce; }
        
        /* ì…ë ¥ì°½ */
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        input { width: 100%; padding: 15px; border: 1px solid var(--border); border-radius: 12px; font-size: 1em; box-sizing: border-box; outline: none; }

        /* ë¬¸í•­ ì¹´ë“œ */
        .q-card { border: 1px solid var(--border); border-radius: 20px; padding: 20px; margin-bottom: 20px; background: #fff; }
        .q-num { font-weight: 800; font-size: 1.2em; margin-bottom: 15px; display: block; color: var(--p); }
        .ans-row { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
        
        /* ë¼ë²¨ í´ë¦­ ìµœì í™” */
        input[type="radio"] { position: absolute; opacity: 0; pointer-events: none; }
        label { height: 50px; display: flex; align-items: center; justify-content: center; border: 1px solid var(--border); border-radius: 12px; cursor: pointer; font-weight: 700; background: #fff; transition: 0.2s; }
        input[type="radio"]:checked + label { background: var(--p); color: white; border-color: var(--p); box-shadow: 0 4px 12px rgba(108, 92, 231, 0.3); }

        .timer-display { text-align: right; color: #ff7675; font-weight: 800; margin-bottom: 10px; }
        .main-btn { width: 100%; padding: 22px; border: none; border-radius: 20px; font-size: 1.2em; font-weight: 800; cursor: pointer; margin-bottom: 15px; transition: 0.3s; }
        #submitBtn { background: var(--p); color: white; box-shadow: 0 8px 20px rgba(108, 92, 231, 0.3); }
        #submitBtn:disabled { background: #cbd5e0; cursor: not-allowed; }
        #kakaoBtn { background: #fee500; color: #3c1e1e; display: none; }

        /* ê²°ê³¼ í™•ì¸ ì˜ì—­ */
        #resultCard { display: none; margin-top: 30px; padding: 25px; border-radius: 25px; border: 3px solid var(--p); background: #fcfaff; animation: slideUp 0.5s ease; }
        #chart_div { width: 100%; height: 250px; margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <div class="header-logo"><img src="https://saenarachild-crypto.github.io/kim-korean-homework/logo.jpg"></div>
    
    <div class="selector-box">
        <select id="examSelect" onchange="loadExam()"></select>
    </div>

    <div id="examPage">
        <div class="notice-box" id="noticeArea"></div>
        <h2 id="activeTitle" style="text-align:center;"></h2>
        <div id="timerDisplay" class="timer-display">â± ìƒíƒœ í™•ì¸ ì¤‘...</div>
        
        <div class="input-grid">
            <input type="text" id="academyName" placeholder="í•™ì›ëª…">
            <input type="text" id="stuName" placeholder="í•™ìƒ ì´ë¦„">
        </div>

        <div id="questionsContainer"></div>

        <div class="submit-area">
            <button type="button" id="submitBtn" class="main-btn" onclick="processSubmit()">ì œì¶œ ë° ì„œë²„ ì±„ì </button>
            <button type="button" id="kakaoBtn" class="main-btn" onclick="shareAndUnlock()">ğŸŸ¡ ì¹´í†¡ ì „ì†¡ í›„ ê²°ê³¼ í™•ì¸</button>
        </div>

        <div id="resultCard">
            <h2 id="resScore" style="margin-top:0; color:var(--p); font-size: 1.6em;"></h2>
            <p id="resFeedback" style="font-weight:700; font-size:1.1em;"></p>
            <div id="resWrongs" style="color:#e74c3c; font-weight:bold; background:#fff0f0; padding:18px; border-radius:15px; margin-top:15px; display:none; word-break: break-all;"></div>
            <div id="chart_div"></div> </div>
    </div>
</div>

<script>
    // êµ¬ê¸€ ì°¨íŠ¸ ë¡œë”©
    google.charts.load('current', {'packages':['corechart']});

    // ğŸ’¡ [ì„ ìƒë‹˜ ì„¤ì • ì˜ì—­] ë¬¸í•­ ìˆ˜(qCount)ì™€ ê¸°í•œ(deadline)ì„ ì—¬ê¸°ì„œ ê´€ë¦¬í•˜ì„¸ìš”.
    const TASKS = {
        "1ì›” 3íšŒì°¨ ë¬¸í•™": { 
            id: "2601_03_LIT", 
            qCount: 31, 
            deadline: "2026-01-26 23:59:59", 
            msg: "ë¬¸í•™ ê³¼ì œì…ë‹ˆë‹¤. ê¸°í•œ ë‚´ì— ì œì¶œí•˜ì„¸ìš”." 
        },
        "1ì›” 3íšŒì°¨ ë…ì„œ": { 
            id: "2601_03_READ", 
            qCount: 42, 
            deadline: "2026-01-28 23:59:59", 
            msg: "ë…ì„œ ê³¼ì œì…ë‹ˆë‹¤. ìˆ˜ì • ë‹µì•ˆì— ì§‘ì¤‘í•˜ì„¸ìš”." 
        }
    };

    // ğŸ”— ì„ ìƒë‹˜ì˜ ìµœì‹  GAS ì„œë²„ ì£¼ì†Œ
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxcT0dziBtsHKDZEPwzyBySOkZjfl3_B7nSysFX7DlXyDKiAD03zLI3jXI8ZBNbA31C/exec";
    const KAKAO_KEY = "f81d5eae0eaaf6fa2d0bdccbe6916001";
    let cur = null, curID = "", tid = null, serverRes = null;

    if (KAKAO_KEY) Kakao.init(KAKAO_KEY);

    window.onload = () => {
        const sel = document.getElementById("examSelect");
        const keys = Object.keys(TASKS);
        keys.forEach(k => { let o = document.createElement("option"); o.value = k; o.innerText = k; sel.appendChild(o); });
        if(keys.length > 0) {
            sel.value = keys[keys.length - 1];
            loadExam();
        }
    };

    function loadExam() {
        if (tid) clearInterval(tid);
        const key = document.getElementById("examSelect").value;
        cur = TASKS[key]; curID = "HW_V65_" + cur.id;
        
        document.getElementById('activeTitle').innerText = key;
        document.getElementById('noticeArea').innerHTML = `<b>[ê³µì§€]</b> ${cur.msg}<br>ğŸ“… <b>ê¸°í•œ:</b> <span style="color:#e74c3c">${cur.deadline}</span>`;
        
        // ë¬¸í•­ ìë™ ìƒì„±
        const container = document.getElementById('questionsContainer');
        let html = "";
        for(let i=1; i<=cur.qCount; i++) {
            html += `<div class="q-card"><span class="q-num">${i}ë²ˆ</span><div class="ans-row">${[1,2,3,4,5].map(n => `<input type="radio" name="q${i}" value="${n}" id="q${i}_${n}_${curID}"><label for="q${i}_${n}_${curID}">${n}</label>`).join('')}</div></div>`;
        }
        container.innerHTML = html;
        
        document.getElementById('resultCard').style.display = 'none';
        document.getElementById('submitBtn').style.display = 'block';
        document.getElementById('kakaoBtn').style.display = 'none';
        
        updateTimerStatus();
        tid = setInterval(updateTimerStatus, 1000);
    }

    async function processSubmit() {
        // [í´ë¼ì´ì–¸íŠ¸ ì¸¡ ê¸°í•œ ì²´í¬]
        if (new Date() > new Date(cur.deadline)) return alert("ì œì¶œ ê¸°í•œì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");

        const name = document.getElementById('stuName').value.trim();
        const academy = document.getElementById('academyName').value.trim();
        if(!name || !academy) return alert("í•™ì›ëª…ê³¼ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
        
        const answers = [];
        for(let i=1; i<=cur.qCount; i++) {
            const val = document.querySelector(`input[name="q${i}"]:checked`)?.value;
            if(!val) return alert(i + "ë²ˆ ì •ë‹µì„ ì„ íƒí•˜ì„¸ìš”.");
            answers.push(Number(val));
        }

        const btn = document.getElementById('submitBtn');
        btn.disabled = true; btn.innerText = "ì„œë²„ ë¶„ì„ ì¤‘...";

        try {
            const response = await fetch(GAS_URL, {
                method: "POST",
                body: JSON.stringify({ examId: cur.id, examTitle: document.getElementById("examSelect").value, name, academy, answers })
            });
            serverRes = await response.json();
            
            if(serverRes.result === "error") throw new Error(serverRes.msg);

            localStorage.setItem(curID + '_tries', serverRes.try);
            localStorage.setItem(curID + '_lock', serverRes.nextAvailableAt);
            
            document.getElementById('submitBtn').style.display = 'none';
            document.getElementById('kakaoBtn').style.display = 'block';
            alert("ì„œë²„ ì±„ì  ì™„ë£Œ! ì¹´í†¡ ê³µìœ  í›„ ê·¸ë˜í”„ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
        } catch(e) { 
            alert(e.message); 
            btn.disabled = false; 
            btn.innerText = "ì œì¶œ ë° ì„œë²„ ì±„ì "; 
        }
    }

    function drawChart() {
        if (!serverRes.history || serverRes.history.length < 2) {
            document.getElementById('chart_div').innerHTML = "<p style='text-align:center; color:#999; font-size:0.8em; margin-top:20px;'>ë°ì´í„°ê°€ ìŒ“ì´ë©´ ì„±ì  ê·¸ë˜í”„ê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</p>";
            return;
        }
        let dataArray = [['ë‚ ì§œ', 'ì ìˆ˜']];
        serverRes.history.forEach(item => dataArray.push([item.date, item.score]));
        let data = google.visualization.arrayToDataTable(dataArray);
        let options = {
            title: 'ë‚˜ì˜ ì„±ì  ë³€í™” ì¶”ì´ (ìµœê·¼ 5íšŒ)',
            curveType: 'function', legend: { position: 'none' },
            colors: ['#6c5ce7'], pointSize: 5,
            vAxis: { minValue: 0, maxValue: 100 },
            animation: { startup: true, duration: 1000, easing: 'out' }
        };
        let chart = new google.visualization.LineChart(document.getElementById('chart_div'));
        chart.draw(data, options);
    }

    function shareAndUnlock() {
        if (!Kakao.isInitialized()) return alert("ì¹´ì¹´ì˜¤ ì¸ì¦ ì˜¤ë¥˜ì…ë‹ˆë‹¤.");
        
        Kakao.Share.sendDefault({
            objectType: 'feed',
            content: {
                title: `[ê³¼ì œ ì œì¶œ ì™„ë£Œ] ${document.getElementById("examSelect").value}`,
                description: `${document.getElementById('stuName').value} í•™ìƒ (${serverRes.score}ì  / ${serverRes.try}íšŒì°¨)`,
                imageUrl: 'https://saenarachild-crypto.github.io/kim-korean-homework/logo.jpg',
                link: { mobileWebUrl: window.location.href, webUrl: window.location.href }
            }
        });

        const kBtn = document.getElementById('kakaoBtn');
        kBtn.innerText = "âœ… ì „ì†¡ ì™„ë£Œ! ê²°ê³¼ ë° ê·¸ë˜í”„ í™•ì¸";
        kBtn.style.background = "#2ecc71"; kBtn.style.color = "#fff";
        
        kBtn.onclick = () => {
            const card = document.getElementById('resultCard');
            card.style.display = 'block';
            document.getElementById('resScore').innerText = `ë‚´ ì ìˆ˜: ${serverRes.score}ì `;
            
            let f = `${serverRes.try}íšŒì°¨ ì œì¶œ ì™„ë£Œ. `;
            if(serverRes.try < (serverRes.max - 1)) {
                f += `ì˜¤ë‹µì€ ì´ ${serverRes.wrongCount}ê°œì…ë‹ˆë‹¤. ë‹¤ì‹œ ê²€í† í•˜ì„¸ìš”!`;
            } else if(serverRes.try == (serverRes.max - 1)) {
                f += `[ë§ˆì§€ë§‰ ì§ì „ íŒíŠ¸] í‹€ë¦° ë²ˆí˜¸: ${serverRes.wrongs}`;
                document.getElementById('resWrongs').innerText = `ìƒì„¸ ì˜¤ë‹µ: ${serverRes.wrongs}`;
                document.getElementById('resWrongs').style.display = 'block';
            } else {
                f += `ìµœì¢… ì œì¶œ ì™„ë£Œ! ì˜¤ë‹µ ë¬¸í•­: ${serverRes.wrongs}`;
                document.getElementById('resWrongs').innerText = `ìµœì¢… ì˜¤ë‹µ: ${serverRes.wrongs}`;
                document.getElementById('resWrongs').style.display = 'block';
            }
            
            document.getElementById('resFeedback').innerText = f;
            drawChart();
            card.scrollIntoView({ behavior: 'smooth' });
            kBtn.style.display = 'none';
        };
    }

    function updateTimerStatus() {
        const lock = localStorage.getItem(curID + '_lock');
        const tries = parseInt(localStorage.getItem(curID + '_tries') || 0);
        const now = new Date().getTime();
        const disk = document.getElementById('timerDisplay');
        
        if (new Date() > new Date(cur.deadline)) {
            disk.innerText = "âš ï¸ ì œì¶œ ê¸°í•œ ì¢…ë£Œ";
            document.getElementById('submitBtn').disabled = true;
        } else if(tries >= 3) {
            disk.innerText = "â± ì œì¶œ íšŸìˆ˜ ì´ˆê³¼";
            document.getElementById('submitBtn').disabled = true;
        } else if(lock && now < lock) {
            const remain = Math.ceil((lock - now) / 1000);
            disk.innerText = `â± ${remain}ì´ˆ í›„ ì¬ì‘ì‹œ ê°€ëŠ¥`;
            document.getElementById('submitBtn').disabled = true;
        } else {
            disk.innerText = "â± ì§€ê¸ˆ ì œì¶œ ê°€ëŠ¥";
            document.getElementById('submitBtn').disabled = false;
        }
    }
</script>
</body>
</html>