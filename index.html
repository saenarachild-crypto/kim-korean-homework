/** 1교시 김현석 국어 - 서버 v79.0 FINAL (교차 검증 탑재) **/
function doPost(e) {
  try {
    const examId = e.parameter.examId, name = e.parameter.name, academy = e.parameter.academy;
    const answers = (e.parameter.answers || "").split(",").map(Number);
    const answerKey = getAnswerKey(examId);
    let wrongs = [];
    answerKey.forEach((v, i) => { if (answers[i] != v) wrongs.push(i + 1); });

    const tryCount = saveAndGetTryCount(name, examId, academy, wrongs);
    const allStatus = checkFullMission(name); // 문학+독서 교차 검증

    return ContentService.createTextOutput(JSON.stringify({
      try: tryCount, wrongCount: wrongs.length, wrongs: wrongs.join(", "),
      history: getHistory(name, examId),
      fullMission: allStatus // {litDone: true/false, readDone: true/false, allDone: true/false}
    })).setMimeType(ContentService.MimeType.JSON);
  } catch (err) {
    return ContentService.createTextOutput(JSON.stringify({ error: true, message: err.message })).setMimeType(ContentService.MimeType.JSON);
  }
}

function checkFullMission(name) {
  const ss = SpreadsheetApp.getActiveSpreadsheet(), sheet = ss.getSheetByName("Log");
  if (!sheet) return {allDone: false};
  const data = sheet.getDataRange().getValues();
  let litCount = 0, readCount = 0;
  for (let i = 1; i < data.length; i++) {
    if (data[i][1] === name) {
      if (data[i][2] === "2601_03_LIT") litCount++;
      if (data[i][2] === "2601_03_READING") readCount++;
    }
  }
  return { litDone: litCount >= 3, readDone: readCount >= 3, allDone: (litCount >= 3 && readCount >= 3) };
}

function saveAndGetTryCount(name, examId, academy, wrongs) {
  const ss = SpreadsheetApp.getActiveSpreadsheet(), sheet = ss.getSheetByName("Log") || ss.insertSheet("Log");
  sheet.appendRow([new Date(), name, examId, academy, wrongs.length, wrongs.join(", ")]);
  const data = sheet.getDataRange().getValues();
  let totalTry = 0;
  for (let i = 1; i < data.length; i++) { if (data[i][1] === name && data[i][2] === examId) totalTry++; }
  return totalTry;
}

function getHistory(name, examId) {
  const ss = SpreadsheetApp.getActiveSpreadsheet(), sheet = ss.getSheetByName("Log");
  if (!sheet) return [];
  const data = sheet.getDataRange().getValues(), history = [];
  for (let i = 1; i < data.length; i++) { if (data[i][1] === name && data[i][2] === examId) history.push({ wrongCount: data[i][4] }); }
  return history;
}

function getAnswerKey(id) {
  if (id === "2601_03_LIT") return "1321525524145132442143332454332".split("").map(Number);
  return "153431412344421245255434314314431345415553".split("").map(Number);
}

function doGet(e) {
  if (e.parameter.check === "true" || e.parameter.sync === "true") {
    const name = e.parameter.name, examId = e.parameter.examId;
    const history = getHistory(name, examId);
    return ContentService.createTextOutput(JSON.stringify({
      finished: history.length >= 3,
      fullMission: checkFullMission(name),
      lastRes: { try: history.length, wrongs: (history.length > 0 ? "서버 재조회 완료" : ""), wrongCount: (history.length > 0 ? history[history.length-1].wrongCount : 0), history: history }
    })).setMimeType(ContentService.MimeType.JSON);
  }
}