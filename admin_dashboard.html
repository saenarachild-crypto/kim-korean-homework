<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ğŸ“Š êµ­ì–´ ê³¼ì œ ê´€ë¦¬ì í†µê³„ ì‹œìŠ¤í…œ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        :root { --p:#6c5ce7; --bg:#f4f7fe; --card:#ffffff; }
        body{font-family:'Apple SD Gothic Neo',sans-serif;background:var(--bg);margin:0;padding:20px;color:#2d3436}
        .wrap{max-width:1200px;margin:auto}
        .header-flex { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        h2{color:var(--p);margin:0; font-size: 1.6rem;}
        .box{background:var(--card);border-radius:20px;padding:25px;margin-bottom:20px;box-shadow:0 10px 25px rgba(108, 92, 231, 0.05)}
        .select-box { display: flex; align-items: center; gap: 15px; font-weight: bold; }
        select{padding:12px 20px;border-radius:12px;border:2px solid #eeebff; outline: none; cursor: pointer; font-family: inherit;}
        
        .grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
        .full{grid-column:span 2}
        .chart-canvas { min-height: 350px; }
        
        table{width:100%;border-collapse:collapse; margin-top: 10px;}
        th,td{padding:12px;border-bottom:1px solid #f1f3f4;text-align:center;font-size:.95rem}
        th{background:#eeebff; color: var(--p); font-weight: bold; border-radius: 5px;}
        .warn{color:#d63031; background: #fff5f5; padding: 4px 10px; border-radius: 8px; font-weight:bold}
        .success{color:#2ecc71; font-weight:bold}
    </style>
</head>
<body>
<div class="wrap">
    <div class="header-flex">
        <h2>ğŸ“Š êµ­ì–´ ê³¼ì œ ì¸í…”ë¦¬ì „ìŠ¤ ëŒ€ì‹œë³´ë“œ</h2>
        <div class="status" id="loadStatus">ë°ì´í„° ë™ê¸°í™” ì¤‘...</div>
    </div>

    <div class="box select-box">
        ğŸ“ ë¶„ì„í•  íšŒì°¨ ì„ íƒ:
        <select id="weekSelect" onchange="drawAll()"></select>
    </div>

    <div class="grid">
        <div class="box"><div id="chartClass" class="chart-canvas"></div></div>
        <div class="box"><div id="chartStudent" class="chart-canvas"></div></div>
        <div class="box full"><div id="chartWrongTop" class="chart-canvas"></div></div>
    </div>

    <div class="box">
        <h3>ğŸš¨ íšŒì°¨ë³„ ì œì¶œ ë¯¸ì™„ë£Œì</h3>
        <table id="missingTable">
            <thead><tr><th>ì†Œì†(í•™ì›)</th><th>ì´ë¦„</th><th>ìµœê·¼ ë„ì „ íšŸìˆ˜</th><th>ìƒíƒœ</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
google.charts.load('current', {'packages':['corechart', 'bar']});
google.charts.setOnLoadCallback(loadData);

// â¬‡â¬‡â¬‡ êµ¬ê¸€ ì‹œíŠ¸ ì •ë³´ (ì´ë¯¸ ì…ë ¥í•˜ì‹  ì£¼ì†Œì™€ ì‹œíŠ¸ëª…) â¬‡â¬‡â¬‡
const SHEET_ID = "1O5D68qRjA9lR2-DqM48KjH0W2YtI-V6K6-V5tY-Y_iE";
const SHEET_NAME = "ê²°ê³¼";

let raw = [];

function loadData(){
    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${SHEET_NAME}`;
    fetch(url).then(r=>r.text()).then(t=>{
        try {
            const json = JSON.parse(t.substring(47,t.length-2));
            // ì‹œíŠ¸ êµ¬ì¡°: [0:ì‹œê°„, 1:ì‹œí—˜ëª…, 2:í•™ì›, 3:ì´ë¦„, 4:ë„ì „íšŸìˆ˜, 5:í‹€ë¦°ê°œìˆ˜, 6:í‹€ë¦°ë²ˆí˜¸]
            raw = json.table.rows.map(r=>r.c.map(c=>c?c.v:""));
            document.getElementById("loadStatus").innerHTML = "âœ… ì‹¤ì‹œê°„ ì—°ê²°ë¨";
            initWeeks();
        } catch(e) {
            document.getElementById("loadStatus").innerHTML = "âŒ ì—°ê²° ì˜¤ë¥˜ (ì‹œíŠ¸ ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”)";
        }
    });
}

function initWeeks(){
    const sel = document.getElementById("weekSelect");
    // ì¤‘ë³µ ì œê±° í›„ íšŒì°¨ ëª©ë¡ ìƒì„±
    const weeks = [...new Set(raw.map(r=>r[1]))].filter(w => w);
    sel.innerHTML = weeks.map(w=>`<option value="${w}">${w}</option>`).join("");
    drawAll();
}

function drawAll(){
    const week = document.getElementById("weekSelect").value;
    if(!week) return;
    const data = raw.filter(r=>r[1]===week);

    drawClassAvg(data);
    drawStudentAvg(data);
    drawWrongTop(data);
    drawMissing(data, week);
}

function drawClassAvg(data){
    const map={};
    data.forEach(r=>{
        if(!map[r[2]]) map[r[2]]=[];
        map[r[2]].push(Number(r[5]));
    });
    const arr=[["í•™ì›/ë°˜","í‰ê·  ì˜¤ë‹µ", { role: "style" }]];
    Object.entries(map).forEach(([k,v])=>{
        arr.push([k, v.reduce((a,b)=>a+b,0)/v.length, "color: #a29bfe"]);
    });
    const dt=google.visualization.arrayToDataTable(arr);
    new google.visualization.ColumnChart(document.getElementById('chartClass')).draw(dt,{
        title:"í•™ì›(ë°˜)ë³„ í‰ê·  ì˜¤ë‹µ ìˆ˜",
        chartArea: {width: '80%', height: '70%'},
        legend: { position: "none" },
        animation: { startup: true, duration: 1000, easing: 'out' }
    });
}

function drawStudentAvg(data){
    const map={};
    data.forEach(r=>{
        // í•™ìƒë³„ë¡œ ê°€ì¥ ìµœê·¼ ê¸°ë¡(í˜¹ì€ í‰ê· ) ë¶„ì„
        if(!map[r[3]]) map[r[3]]=[];
        map[r[3]].push(Number(r[5]));
    });
    const arr=[["í•™ìƒ","í‰ê·  ì˜¤ë‹µ", { role: "style" }]];
    Object.entries(map).sort((a,b)=>b[1][0]-a[1][0]).forEach(([k,v])=>{
        arr.push([k, v.reduce((a,b)=>a+b,0)/v.length, "color: #6c5ce7"]);
    });
    const dt=google.visualization.arrayToDataTable(arr);
    new google.visualization.BarChart(document.getElementById('chartStudent')).draw(dt,{
        title:"í•™ìƒë³„ í‰ê·  ì˜¤ë‹µ (í•™ìŠµ ì„±ì·¨ë„)",
        chartArea: {width: '60%', height: '80%'},
        legend: { position: "none" }
    });
}

function drawWrongTop(data){
    const count={};
    data.forEach(r=>{
        if(r[6]){
            r[6].toString().split(",").forEach(n=>{
                const num = n.trim();
                if(num){count[num]=(count[num]||0)+1;}
            });
        }
    });
    const top=Object.entries(count).sort((a,b)=>b[1]-a[1]).slice(0,10); // TOP 10ìœ¼ë¡œ í™•ëŒ€
    const arr=[["ë¬¸í•­","ì˜¤ë‹µ ì¸ì›"]];
    top.forEach(t=>arr.push([t[0]+"ë²ˆ",t[1]]));
    const dt=google.visualization.arrayToDataTable(arr);
    new google.visualization.PieChart(document.getElementById('chartWrongTop')).draw(dt,{
        title:"ê°€ì¥ ë§ì´ í‹€ë¦° ë¬¸í•­ ë¶„ì„ (TOP 10)",
        pieHole: 0.4,
        colors: ['#6c5ce7', '#a29bfe', '#8e7cf0', '#d1d8ff', '#f1f3f4']
    });
}

function drawMissing(data, currentWeek){
    const tb = document.querySelector("#missingTable tbody");
    tb.innerHTML = "";
    
    // ì „ì²´ í•™ìƒ ëª©ë¡ (ì „ì²´ ì‹œíŠ¸ ë°ì´í„°ì—ì„œ ì¶”ì¶œ)
    const allStudentsMap = {};
    raw.forEach(r => { if(r[3]) allStudentsMap[r[3]] = r[2]; });
    
    // í˜„ì¬ íšŒì°¨ ì œì¶œ í•™ìƒ ì´ë¦„
    const submittedNames = data.map(r => r[3]);
    
    Object.entries(allStudentsMap).forEach(([name, academy]) => {
        if(!submittedNames.includes(name)){
            tb.innerHTML += `<tr><td>${academy}</td><td>${name}</td><td>0íšŒ</td><td class="warn">ë¯¸ì œì¶œ</td></tr>`;
        } else {
            // ì œì¶œí•œ ê²½ìš° ìµœì‹  ì‹œë„ íšŸìˆ˜ í‘œì‹œ
            const studentData = data.filter(d => d[3] === name);
            const attempts = studentData[studentData.length - 1][4];
            tb.innerHTML += `<tr><td>${academy}</td><td>${name}</td><td>${attempts}íšŒ</td><td class="success">ì œì¶œì™„ë£Œ</td></tr>`;
        }
    });
}
</script>
</body>
</html>