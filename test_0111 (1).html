<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>1ì›” 2ì£¼ì°¨ ë…ì„œ ìˆ˜ì—… êµì¬</title>
    <style>
        body{font-family:-apple-system,sans-serif;background:#f0f2f5;padding:15px;margin:0}
        .container{max-width:600px;margin:0 auto;background:#fff;padding:25px;border-radius:15px;box-shadow:0 4px 15px rgba(0,0,0,0.1)}
        .header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px; }
        .title { margin: 5px 0; color: #333; }
        .notice-box { background: #fff3e0; border: 1px solid #ffe0b2; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 0.95rem; line-height: 1.5; color: #5d4037; }
        .link-btn { display: block; width: 100%; text-align: center; padding: 12px; border-radius: 8px; text-decoration: none; font-weight: bold; margin-bottom: 10px; transition: 0.2s; box-sizing: border-box; }
        .btn-test { background: #607d8b; color: white; }
        .btn-ans { background: #4caf50; color: white; margin-top: 15px; }
        .btn-kakao { background: #fee500; color: #3c1e1e; border: none; width: 100%; padding: 15px; border-radius: 10px; font-weight: bold; font-size: 1.1rem; cursor: pointer; margin: 20px 0; display: none; }
        .q-item { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: space-between; }
        .q-num { font-weight: bold; color: #2196f3; width: 40px; }
        .omr-group { display: flex; gap: 8px; flex: 1; justify-content: space-around; }
        .omr-input { display: none; }
        .omr-label { width: 35px; height: 35px; border-radius: 50%; border: 2px solid #ddd; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #999; cursor: pointer; transition: 0.2s; }
        .omr-input:checked + .omr-label { background: #2196f3; border-color: #2196f3; color: white; }
        .btn-submit { display: block; width: 100%; padding: 15px; background: #ff6b6b; color: white; border: none; border-radius: 10px; font-weight: bold; font-size: 1.1rem; cursor: pointer; margin-top:20px; }
        .btn-submit:disabled { background: #ccc !important; cursor: not-allowed; }
        .result-box { display: none; margin-top: 25px; padding: 20px; border-radius: 10px; text-align: center; background: #e3f2fd; }
        .pass { background: #e8f5e9; border: 2px solid #4caf50; color: #2e7d32; }
        .fail { background: #ffebee; border: 2px solid #ef5350; color: #c62828; }
        input[type=text] { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        #timerMsg { text-align: center; color: #d32f2f; font-weight: bold; margin: 10px 0; display: none; }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h2 class="title">1ì›” 2ì£¼ì°¨ ë…ì„œ ìˆ˜ì—… êµì¬</h2>
        <div style="font-size:0.9rem; color:#666">ì´ 31ë¬¸í•­ (í†µê³¼ê¸°ì¤€: 0ê°œ ì˜¤ë‹µ)</div>
    </div>
    
    <a href="https://goe2427-my.sharepoint.com/:b:/g/personal/pure173_jeonghyeonh_goe_go_kr/IQBVwOJZiRQgS6_ugDNnoVYoAZMB_ebihxSBPKNw-Rl8GAY?e=j9iOvA" class="link-btn btn-test" target="_blank">ğŸ“„ ì‹œí—˜ì§€ ë³´ëŸ¬ê°€ê¸° (Click)</a>
    
    <div class="notice-box">
        ğŸ“¢ <b>í•„ë… ê³µì§€</b><br>
        1. ì œì¶œ í›„ <b>ê³µìœ  ì°½ì—ì„œ ì „ì†¡ê¹Œì§€ ì™„ë£Œ</b>í•´ì•¼ ì±„ì ì´ ì¸ì •ë©ë‹ˆë‹¤.<br>
        2. ì˜¤ë‹µ ì‹œ <b>3ë¶„ê°„ ì¬ì œì¶œì´ ì°¨ë‹¨</b>ë©ë‹ˆë‹¤.<br>
        3. ë„ì „ ê¸°íšŒëŠ” í•™ìƒë‹¹ <b>ì´ 3íšŒ</b>ì…ë‹ˆë‹¤.
    </div>

    <div style="margin-bottom:20px; background:#fafafa; padding:15px; border-radius:8px;">
        <label style="font-weight:bold; color:#d63031;">ğŸ« í•™ì› ì´ë¦„ (í•„ìˆ˜)</label>
        <input type="text" id="academySelect" placeholder="í•™ì›ëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
        <label style="font-weight:bold; margin-top:10px; display:block;">ğŸ‘¤ í•™ìƒ ì´ë¦„</label>
        <input type="text" id="studentName" placeholder="ë³¸ì¸ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
    </div>

    <div id="questionContainer"></div>
    <div id="timerMsg">â³ ì¬ì œì¶œ ëŒ€ê¸° ì‹œê°„ì´ ë‚¨ì•˜ìŠµë‹ˆë‹¤.</div>
    <button id="submitBtn" class="btn-submit" onclick="processSubmission()">ğŸ“ ë‹µì•ˆ ì œì¶œí•˜ê¸°</button>
    <button id="kakaoBtn" class="btn-kakao" onclick="handleShare()">ğŸŸ¡ ì¹´í†¡ìœ¼ë¡œ ì„ ìƒë‹˜ê»˜ ê²°ê³¼ ì „ì†¡ (í•„ìˆ˜)</button>
    <div id="resultArea" class="result-box"></div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyE8PE7KjrTiBVljInx24PqPBoFbQ5ga4oWqhMg90UFXjFvrmB0YWhNVreRCWYyeq8/exec"; 
    // âœ… 31ê°œ ì •ë‹µ ë°°ì—´ (ì´ë¯¸ì§€ test_0111 (1).html ë°ì´í„° ê¸°ë°˜)
    const correctAnswers = [3, 3, 3, 2, 3, 4, 4, 5, 4, 4, 4, 3, 3, 5, 4, 1, 2, 2, 5, 2, 1, 3, 5, 2, 1, 4, 3, 5, 4];
    const ANSWER_LINK = "https://goe2427-my.sharepoint.com/:b:/g/personal/pure173_jeonghyeonh_goe_go_kr/IQA3sl-2anvxR4EbouLfFbiTAZziHwR59bTxnjZbnBE06XU?e=kpAH4M"; 
    const MAX_ATTEMPTS = 3;
    const COOLDOWN_MINUTES = 3;
    const STORAGE_KEY = "reading_v2_week2_final_lock"; // ê³ ìœ  í‚¤ê°’

    let attempt = 0;
    let lastSubmitTime = 0;
    let finalWrongCount = 0;
    let finalShareData = {};

    window.onload = function() {
        let html = "";
        for(let i=1; i<=correctAnswers.length; i++) {
            html += `<div class="q-item"><span class="q-num">${i}ë²ˆ</span><div class="omr-group">`;
            for(let j=1; j<=5; j++) {
                html += `<input type="radio" name="q${i}" id="q${i}_${j}" value="${j}" class="omr-input"><label for="q${i}_${j}" class="omr-label">${j}</label>`;
            }
            html += '</div></div>';
        }
        document.getElementById("questionContainer").innerHTML = html;
        loadStatus();
    };

    function loadStatus() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if(saved) {
            const data = JSON.parse(saved);
            attempt = data.attempt || 0;
            lastSubmitTime = data.lastTime || 0;
            if(data.name) document.getElementById("studentName").value = data.name;
            if(data.academy) document.getElementById("academySelect").value = data.academy;
            
            if(attempt >= MAX_ATTEMPTS) {
                disableSubmit("ğŸš« ëª¨ë“  ê¸°íšŒ ì†Œì§„ (ì œì¶œ ë¶ˆê°€)");
                return;
            }

            const now = Date.now();
            const diff = (now - lastSubmitTime) / 1000;
            if(diff < COOLDOWN_MINUTES * 60) {
                startCooldown(Math.ceil(COOLDOWN_MINUTES * 60 - diff));
            }
        }
    }

    function processSubmission() {
        const name = document.getElementById("studentName").value.trim();
        const academy = document.getElementById("academySelect").value.trim(); 
        if(!academy || !name) return alert("ì´ë¦„ê³¼ í•™ì›ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
        for(let i=1; i<=correctAnswers.length; i++) {
            if(!document.querySelector(`input[name="q${i}"]:checked`)) return alert(i + "ë²ˆì„ ë§ˆí‚¹í•´ì£¼ì„¸ìš”!");
        }

        let wrongCount = 0;
        let wrongList = [];
        for(let i=0; i<correctAnswers.length; i++) {
            const val = document.querySelector(`input[name="q${i+1}"]:checked`).value;
            if(parseInt(val) !== correctAnswers[i]) {
                wrongCount++;
                wrongList.push((i+1)+"ë²ˆ");
            } 
        }

        finalWrongCount = wrongCount;
        finalShareData = {
            title: "ë…ì„œ ê³¼ì œ ê²°ê³¼",
            text: `[ë…ì„œ ê³¼ì œ Report]\ní•™ì›: ${academy}\ní•™ìƒ: ${name}\ní‹€ë¦° ê°œìˆ˜: ${wrongCount}ê°œ\nì°¨ìˆ˜: ${attempt + 1}/${MAX_ATTEMPTS}íšŒ`
        };

        // ì—‘ì…€ ì „ì†¡
        const sendData = {
            title: document.title, academy: academy, name: name,
            score: correctAnswers.length - wrongCount, total: correctAnswers.length,
            wrongCount: wrongCount, wrongList: wrongList.join(", "), attempt: attempt + 1
        };
        fetch(SCRIPT_URL + "?data=" + btoa(unescape(encodeURIComponent(JSON.stringify(sendData)))), { mode: 'no-cors' });

        document.getElementById("submitBtn").style.display = "none";
        document.getElementById("kakaoBtn").style.display = "block";
        alert("ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ì¹´í†¡ ì „ì†¡ì„ ì™„ë£Œí•´ì•¼ ì±„ì  ê²°ê³¼ê°€ ê³µê°œë©ë‹ˆë‹¤.");
    }

    async function handleShare() {
        try {
            if (navigator.share) {
                await navigator.share(finalShareData);
            } else {
                location.href = "kakaotalk://send?text=" + encodeURIComponent(finalShareData.text);
                await new Promise(r => setTimeout(r, 1500));
            }
            finalizeAttempt();
        } catch (err) {
            alert("ì „ì†¡ì„ ì™„ë£Œí•´ì•¼ ì±„ì ì´ ì¸ì •ë©ë‹ˆë‹¤.");
        }
    }

    function finalizeAttempt() {
        attempt++;
        lastSubmitTime = Date.now();
        localStorage.setItem(STORAGE_KEY, JSON.stringify({
            attempt: attempt, lastTime: lastSubmitTime,
            name: document.getElementById("studentName").value,
            academy: document.getElementById("academySelect").value
        }));

        const res = document.getElementById("resultArea");
        res.style.display = "block";
        const isPass = finalWrongCount === 0;
        res.className = isPass ? "result-box pass" : "result-box fail";
        
        let resHtml = `<h3>ì±„ì  ì™„ë£Œ (${attempt}/${MAX_ATTEMPTS}íšŒ)</h3><p>ì´ <b>${finalWrongCount}</b>ê°œ í‹€ë ¸ìŠµë‹ˆë‹¤.</p>`;
        
        if(isPass || attempt >= MAX_ATTEMPTS) {
            resHtml += `<a href="${ANSWER_LINK}" class="link-btn btn-ans" target="_blank">ğŸ“˜ ì •ë‹µ ë° í•´ì„¤ì§€ ë³´ê¸°</a>`;
            disableSubmit(attempt >= MAX_ATTEMPTS ? "ğŸš« ê¸°íšŒ ì†Œì§„" : "âœ… í†µê³¼ ì™„ë£Œ");
        } else {
            resHtml += `<p>ì˜¤ë‹µì´ ìˆìŠµë‹ˆë‹¤. ${COOLDOWN_MINUTES}ë¶„ í›„ ë‹¤ì‹œ í’€ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>`;
            startCooldown(COOLDOWN_MINUTES * 60);
        }
        
        res.innerHTML = resHtml;
        document.getElementById("kakaoBtn").style.display = "none";
        document.getElementById("submitBtn").style.display = "block";
        res.scrollIntoView({behavior:"smooth"});
    }

    function startCooldown(sec) {
        const btn = document.getElementById("submitBtn");
        const msg = document.getElementById("timerMsg");
        btn.disabled = true;
        msg.style.display = "block";
        let remain = sec;
        
        const timer = setInterval(() => {
            remain--;
            if(remain <= 0) {
                clearInterval(timer);
                btn.disabled = false;
                btn.innerText = "ğŸ“ ë‹¤ì‹œ ì œì¶œí•˜ê¸°";
                msg.style.display = "none";
            } else {
                btn.innerText = `â³ ëŒ€ê¸° (${remain}ì´ˆ)`;
            }
        }, 1000);
    }

    function disableSubmit(txt) {
        const btn = document.getElementById("submitBtn");
        btn.disabled = true;
        btn.style.display = "block";
        btn.innerText = txt;
        document.getElementById("kakaoBtn").style.display = "none";
    }
</script>
</body>
</html>