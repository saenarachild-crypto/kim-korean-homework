<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê³¼ì œ í˜ì´ì§€ ìƒì„±ê¸° v2.4 (ì„ ìƒë‹˜ ì „ìš©)</title>
    <style>
        body { font-family: 'Apple SD Gothic Neo', sans-serif; padding: 20px; background: #f0f2f5; line-height: 1.6; }
        .box { max-width: 800px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        h2 { border-left: 5px solid #2196f3; padding-left: 15px; color: #333; margin-bottom: 25px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        label { display: block; margin-top: 15px; font-weight: bold; color: #444; }
        input, textarea { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 14px; }
        textarea { height: 80px; resize: none; }
        button { width: 100%; padding: 15px; background: #2196f3; color: white; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 25px; }
        #output { width: 100%; height: 350px; margin-top: 20px; font-family: 'Consolas', monospace; background: #2d3436; color: #dfe6e9; padding: 15px; border-radius: 8px; font-size: 12px; }
        .section-title { background: #e3f2fd; padding: 10px; border-radius: 5px; margin-top: 20px; font-weight: bold; color: #1976d2; }
        .hint { font-size: 0.8rem; color: #666; margin-top: 4px; }
    </style>
</head>
<body>
<div class="box">
    <h2>ğŸš€ ê³¼ì œ í˜ì´ì§€ ìƒì„±ê¸° v2.4</h2>
    
    <div class="section-title">ğŸ“… ê³¼ì œ ê¸°ë³¸ ì„¤ì •</div>
    <label>ê³¼ì œ ì œëª©</label>
    <input type="text" id="title" value="1ì›” 3ì£¼ì°¨ ê³¼ì œ">
    
    <label>ì „ì²´ ì •ë‹µ ë²ˆí˜¸ (ìˆ«ìë§Œ ì­‰ ì…ë ¥)</label>
    <textarea id="answers" placeholder="ì˜ˆ: 311454... (ì „ì²´ ë¬¸í•­ì˜ ì •ë‹µì„ ìˆœì„œëŒ€ë¡œ ì…ë ¥)"></textarea>

    <label>âœ… í™œì„±í™”í•  ë¬¸í•­ ë²ˆí˜¸ (ë§ˆí‚¹ í—ˆìš© êµ¬ê°„)</label>
    <input type="text" id="activeRange" placeholder="ì˜ˆ: 6-13, 30-39">
    <div class="hint">â€» ì‰¼í‘œ(,)ë‚˜ ëŒ€ì‹œ(-)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì…ë ¥í•˜ì„¸ìš”. (ì˜ˆ: 1-5, 10, 15-20)</div>

    <div class="grid">
        <div><label>ì‹œí—˜ì§€ PDF ë§í¬</label><input type="text" id="testLink"></div>
        <div><label>í•´ì„¤ì§€ PDF ë§í¬</label><input type="text" id="ansLink"></div>
    </div>

    <div class="section-title">âš™ï¸ ì‹œí—˜ ê·œì¹™</div>
    <div class="grid">
        <div><label>ìµœëŒ€ ë„ì „ íšŸìˆ˜ (íšŒ)</label><input type="number" id="maxAttempts" value="3"></div>
        <div><label>ì¬ì œì¶œ ëŒ€ê¸° ì‹œê°„ (ë¶„)</label><input type="number" id="cooldown" value="3"></div>
    </div>

    <button onclick="generateCode()">âœ¨ ë§ì¶¤í˜• HTML ì½”ë“œ ìƒì„±í•˜ê¸°</button>
    
    <label>ğŸ“‹ ê²°ê³¼ ì½”ë“œ (í´ë¦­í•˜ë©´ ìë™ ì„ íƒ ë° ë³µì‚¬)</label>
    <textarea id="output" readonly onclick="copyCode()"></textarea>
</div>

<script>
function parseRange(str) {
    const activeNums = new Set();
    const parts = str.split(',');
    parts.forEach(part => {
        const range = part.trim().split('-');
        if (range.length === 2) {
            for (let i = parseInt(range[0]); i <= parseInt(range[1]); i++) activeNums.add(i);
        } else {
            const num = parseInt(range[0]);
            if (!isNaN(num)) activeNums.add(num);
        }
    });
    return Array.from(activeNums).sort((a, b) => a - b);
}

function generateCode() {
    const title = document.getElementById('title').value;
    const rawAns = document.getElementById('answers').value.replace(/[^1-5]/g, '');
    const ansArray = rawAns.split('').map(Number);
    if(ansArray.length === 0) return alert("ì •ë‹µ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");

    const activeRangeStr = document.getElementById('activeRange').value;
    if(!activeRangeStr) return alert("í™œì„±í™”í•  ë¬¸í•­ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”! (ì˜ˆ: 6-13, 30-39)");
    const activeQuestions = parseRange(activeRangeStr);

    const testLink = document.getElementById('testLink').value || "#";
    const ansLink = document.getElementById('ansLink').value || "#";
    const maxAttempts = document.getElementById('maxAttempts').value || 3;
    const cooldown = document.getElementById('cooldown').value || 3;
    const scriptUrl = "https://script.google.com/macros/s/AKfycbyE8PE7KjrTiBVljInx24PqPBoFbQ5ga4oWqhMg90UFXjFvrmB0YWhNVreRCWYyeq8/exec";

    let code = `<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>${title}</title>
    <style>
        body{font-family:-apple-system,sans-serif;background:#f0f2f5;padding:15px;margin:0}
        .container{max-width:600px;margin:0 auto;background:#fff;padding:25px;border-radius:15px;box-shadow:0 4px 15px rgba(0,0,0,0.1)}
        .header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px; }
        .notice-box { background: #fff3e0; border: 1px solid #ffe0b2; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 0.95rem; line-height: 1.5; color: #5d4037; }
        .link-btn { display: block; width: 100%; text-align: center; padding: 12px; border-radius: 8px; text-decoration: none; font-weight: bold; margin-bottom: 10px; box-sizing: border-box; }
        .btn-test { background: #607d8b; color: white; }
        .btn-ans { background: #4caf50; color: white; margin-top: 15px; }
        .btn-kakao { background: #fee500; color: #3c1e1e; border: none; width: 100%; padding: 15px; border-radius: 10px; font-weight: bold; font-size: 1.1rem; cursor: pointer; margin: 20px 0; display: none; }
        .q-item { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: space-between; }
        .skipped-item { background: #f5f5f5; opacity: 0.5; pointer-events: none; }
        .q-num { font-weight: bold; color: #2196f3; width: 60px; }
        .omr-group { display: flex; gap: 8px; flex: 1; justify-content: space-around; }
        .omr-input { display: none; }
        .omr-label { width: 35px; height: 35px; border-radius: 50%; border: 2px solid #ddd; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #999; cursor: pointer; }
        .omr-input:checked + .omr-label { background: #2196f3; border-color: #2196f3; color: white; }
        .btn-submit { display: block; width: 100%; padding: 15px; background: #ff6b6b; color: white; border: none; border-radius: 10px; font-weight: bold; font-size: 1.1rem; cursor: pointer; margin-top:20px; }
        .btn-submit:disabled { background: #ccc !important; cursor: not-allowed; }
        .result-box { display: none; margin-top: 25px; padding: 20px; border-radius: 10px; text-align: center; background: #e3f2fd; }
        .pass { background: #e8f5e9; border: 2px solid #4caf50; color: #2e7d32; }
        .fail { background: #ffebee; border: 2px solid #ef5350; color: #c62828; }
        input[type=text] { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        #timerMsg { text-align: center; color: #d32f2f; font-weight: bold; margin: 10px 0; display: none; }
    </style>
</head>
<body>
<div class="container">
    <div class="header"><h2>${title}</h2><div style="font-size:0.9rem; color:#666">ì´ ${ansArray.length}ë¬¸í•­ ì¤‘ í™œì„± ë¬¸í•­ë§Œ ë§ˆí‚¹ ê°€ëŠ¥</div></div>
    <a href="${testLink}" class="link-btn btn-test" target="_blank">ğŸ“„ ì‹œí—˜ì§€ ë³´ëŸ¬ê°€ê¸°</a>
    <div class="notice-box">ğŸ“¢ <b>í•„ë…</b>: ì§€ì •ëœ ë¬¸í•­ë§Œ ê³¼ì œì…ë‹ˆë‹¤. ì „ì†¡ ì™„ë£Œ ì‹œ ê²°ê³¼ê°€ ê³µê°œë©ë‹ˆë‹¤.</div>
    <div style="margin-bottom:20px; background:#fafafa; padding:15px; border-radius:8px;">
        <label>ğŸ« í•™ì› ì´ë¦„</label><input type="text" id="academySelect" placeholder="í•™ì›ëª… ì…ë ¥">
        <label>ğŸ‘¤ í•™ìƒ ì´ë¦„</label><input type="text" id="studentName" placeholder="ë³¸ì¸ ì´ë¦„ ì…ë ¥">
    </div>
    <div id="questionContainer"></div>
    <div id="timerMsg">â³ ëŒ€ê¸° ì‹œê°„ì´ ë‚¨ì•˜ìŠµë‹ˆë‹¤.</div>
    <button id="submitBtn" class="btn-submit" onclick="processSubmission()">ğŸ“ ë‹µì•ˆ ì œì¶œí•˜ê¸°</button>
    <button id="kakaoBtn" class="btn-kakao" onclick="handleShare()">ğŸŸ¡ ì¹´í†¡ìœ¼ë¡œ ì„ ìƒë‹˜ê»˜ ê²°ê³¼ ì „ì†¡</button>
    <div id="resultArea" class="result-box"></div>
</div>
<script>
    const SCRIPT_URL = "${scriptUrl}"; 
    const correctAnswers = [${ansArray.join(',')}];
    const activeQuestions = [${activeQuestions.join(',')}];
    const ANSWER_LINK = "${ansLink}"; 
    const MAX_ATTEMPTS = ${maxAttempts};
    const COOLDOWN_MINUTES = ${cooldown};
    const STORAGE_KEY = "test_" + "${title.replace(/\s/g,'')}" + "_" + Date.now();

    let attempt = 0; let lastSubmitTime = 0; let finalWrongCount = 0; let finalShareData = {};

    window.onload = function() {
        let html = "";
        for(let i=1; i<=correctAnswers.length; i++) {
            let isActive = activeQuestions.includes(i);
            html += '<div class="q-item ' + (isActive ? '' : 'skipped-item') + '"><span class="q-num">'+i+'ë²ˆ' + (isActive ? '' : ' (ì œì™¸)') + '</span><div class="omr-group">';
            if(isActive) {
                for(let j=1; j<=5; j++) {
                    html += '<input type="radio" name="q'+i+'" id="q'+i+'_'+j+'" value="'+j+'" class="omr-input"><label for="q'+i+'_'+j+'" class="omr-label">'+j+'</label>';
                }
            }
            html += '</div></div>';
        }
        document.getElementById("questionContainer").innerHTML = html;
        loadStatus();
    };

    function loadStatus() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if(saved) {
            const data = JSON.parse(saved);
            attempt = data.attempt || 0; lastSubmitTime = data.lastTime || 0;
            if(attempt >= MAX_ATTEMPTS) { disableSubmit("ğŸš« ëª¨ë“  ê¸°íšŒ ì†Œì§„"); return; }
            const diff = (Date.now() - lastSubmitTime) / 1000;
            if(diff < COOLDOWN_MINUTES * 60) startCooldown(Math.ceil(COOLDOWN_MINUTES * 60 - diff));
        }
    }

    function processSubmission() {
        const name = document.getElementById("studentName").value.trim();
        const academy = document.getElementById("academySelect").value.trim(); 
        if(!academy || !name) return alert("ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
        for(let i of activeQuestions) {
            if(!document.querySelector('input[name="q'+i+'"]:checked')) return alert(i + "ë²ˆì„ ë§ˆí‚¹í•´ì£¼ì„¸ìš”!");
        }
        let wrongCount = 0; let wrongList = [];
        for(let i of activeQuestions) {
            const val = document.querySelector('input[name="q'+i+'"]:checked').value;
            if(parseInt(val) !== correctAnswers[i-1]) { wrongCount++; wrongList.push(i+"ë²ˆ"); }
        }
        finalWrongCount = wrongCount;
        finalShareData = { title: "ê³¼ì œ ê²°ê³¼", text: "[${title}]\\ní•™ì›: "+academy+"\\ní•™ìƒ: "+name+"\\ní‹€ë¦° ê°œìˆ˜: "+wrongCount+"ê°œ" };
        const sendData = { title: "${title}", academy: academy, name: name, score: activeQuestions.length-wrongCount, total: activeQuestions.length, wrongCount: wrongCount, wrongList: wrongList.join(", "), attempt: attempt+1 };
        fetch(SCRIPT_URL + "?data=" + btoa(unescape(encodeURIComponent(JSON.stringify(sendData)))), { mode: 'no-cors' });
        document.getElementById("submitBtn").style.display = "none";
        document.getElementById("kakaoBtn").style.display = "block";
        alert("ì €ì¥ ì™„ë£Œ! ì¹´í†¡ ì „ì†¡ì„ ë§ˆì³ì•¼ ê²°ê³¼ê°€ ë³´ì…ë‹ˆë‹¤.");
    }

    async function handleShare() {
        try {
            if (navigator.share) { await navigator.share(finalShareData); } 
            else { location.href = "kakaotalk://send?text=" + encodeURIComponent(finalShareData.text); await new Promise(r => setTimeout(r, 1500)); }
            finalizeAttempt();
        } catch (err) { alert("ì „ì†¡ì„ ì™„ë£Œí•´ì•¼ ì±„ì ì´ ë©ë‹ˆë‹¤."); }
    }

    function finalizeAttempt() {
        attempt++; lastSubmitTime = Date.now();
        localStorage.setItem(STORAGE_KEY, JSON.stringify({ attempt: attempt, lastTime: lastSubmitTime, name: document.getElementById("studentName").value, academy: document.getElementById("academySelect").value }));
        const res = document.getElementById("resultArea");
        res.style.display = "block";
        res.className = finalWrongCount === 0 ? "result-box pass" : "result-box fail";
        let resHtml = "<h3>ì±„ì  ì™„ë£Œ</h3><p>ì´ <b>"+finalWrongCount+"</b>ê°œ í‹€ë ¸ìŠµë‹ˆë‹¤.</p>";
        if(finalWrongCount === 0 || attempt >= MAX_ATTEMPTS) { resHtml += '<a href="'+ANSWER_LINK+'" class="link-btn btn-ans" target="_blank">ğŸ“˜ ì •ë‹µ ë° í•´ì„¤ì§€ ë³´ê¸°</a>'; disableSubmit(attempt >= MAX_ATTEMPTS ? "ğŸš« ê¸°íšŒ ì†Œì§„" : "âœ… í†µê³¼ ì™„ë£Œ"); }
        else { resHtml += "<p>ì˜¤ë‹µì´ ìˆìŠµë‹ˆë‹¤. "+COOLDOWN_MINUTES+"ë¶„ í›„ ì¬ë„ì „ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>"; startCooldown(COOLDOWN_MINUTES * 60); }
        res.innerHTML = resHtml;
        document.getElementById("kakaoBtn").style.display = "none";
        document.getElementById("submitBtn").style.display = "block";
        res.scrollIntoView({behavior:"smooth"});
    }

    function startCooldown(sec) {
        const btn = document.getElementById("submitBtn"); const msg = document.getElementById("timerMsg");
        btn.disabled = true; msg.style.display = "block";
        let remain = sec;
        const timer = setInterval(() => {
            remain--;
            if(remain <= 0) { clearInterval(timer); btn.disabled = false; btn.innerText = "ğŸ“ ë‹¤ì‹œ ì œì¶œí•˜ê¸°"; msg.style.display = "none"; }
            else { btn.innerText = "â³ ëŒ€ê¸° ("+remain+"ì´ˆ)"; }
        }, 1000);
    }

    function disableSubmit(txt) {
        const btn = document.getElementById("submitBtn"); btn.disabled = true; btn.style.display = "block";
        btn.innerText = txt; document.getElementById("kakaoBtn").style.display = "none";
    }
<\/script>
</body>
</html>`;

    document.getElementById('output').value = code;
    alert("ì½”ë“œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! í´ë¦­í•˜ì—¬ ë³µì‚¬í•˜ì„¸ìš”.");
}

function copyCode() {
    const output = document.getElementById('output');
    output.select();
    document.execCommand('copy');
    alert("ì½”ë“œê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
}
</script>
</body>
</html>